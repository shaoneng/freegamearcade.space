name: Daily AI-Powered Game Scraper and Deploy

on:
  workflow_dispatch: # 允许手动触发
  schedule:
    - cron: '0 1 * * *' # 每天UTC时间1点运行

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # 设置环境变量，以便Python脚本可以访问API密钥
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Set up Python 🐍
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies 📦
        run: |
          python -m pip install --upgrade pip
          # 新增 google-generativeai 依赖
          pip install requests beautifulsoup4 google-generativeai

      - name: Run Scraper and AI Page Generator 🏃
        # Python脚本将通过 os.getenv("GEMINI_API_KEY") 自动获取密钥
        run: python main.py

      - name: Commit data files 💾
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add games_archive.json processed_games.txt
          git diff --staged --quiet || git commit -m "chore: 更新游戏数据库"
          git push origin main || echo "No changes to commit"

      - name: Deploy to GitHub Pages 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages # 部署到的分支
          folder: generated_pages # 要部署的文件夹
          clean: true
